DB_DIR=/nextpnr-xilinx/xilinx/external/prjxray-db
CHIPDB=/chipdb
CHIPFAM=zync7
ADDITIONAL_SOURCES = AXISoCQuadCoreModule_TopLevel.v AXISoCQuadCoreModule_TopLevel_Buttons.v AXISoCQuadCoreModule_TopLevel_Buttons_axiSlave.v AXISoCQuadCoreModule_TopLevel_CPU0.v AXISoCQuadCoreModule_TopLevel_cpu0AutoDecrementRegister.v AXISoCQuadCoreModule_TopLevel_cpu0AutoDecrementRegister_axiSlave.v AXISoCQuadCoreModule_TopLevel_cpu0AutoIncrementCounter.v AXISoCQuadCoreModule_TopLevel_cpu0AutoIncrementCounter_axiSlave.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_DuplexMux.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_Encoder.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_rangeDetectorArray0.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_rangeDetectorArray0_encoder.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_rangeDetectorArray0_rangeDetectors0.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_rangeDetectorArray0_rangeDetectors1.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_rangeDetectorArray0_rangeDetectors2.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_rangeDetectorArray0_rangeDetectors3.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_rangeDetectorArray1.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_rangeDetectorArray1_encoder.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_rangeDetectorArray1_rangeDetectors0.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_rangeDetectorArray1_rangeDetectors1.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_rangeDetectorArray1_rangeDetectors2.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_rangeDetectorArray1_rangeDetectors3.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_TransactionDetectors0.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_readInterconnect_TransactionDetectors1.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_DuplexMux.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_Encoder.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_rangeDetectorArray0.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_rangeDetectorArray0_encoder.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors0.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors1.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors2.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors3.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_rangeDetectorArray1.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_rangeDetectorArray1_encoder.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_rangeDetectorArray1_rangeDetectors0.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_rangeDetectorArray1_rangeDetectors1.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_rangeDetectorArray1_rangeDetectors2.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_rangeDetectorArray1_rangeDetectors3.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_TransactionDetectors0.v AXISoCQuadCoreModule_TopLevel_cpu0Interconnect_writeInterconnect_TransactionDetectors1.v AXISoCQuadCoreModule_TopLevel_cpu0IOGateway.v AXISoCQuadCoreModule_TopLevel_cpu0IOGateway_readAddress.v AXISoCQuadCoreModule_TopLevel_cpu0IOGateway_writeAddress.v AXISoCQuadCoreModule_TopLevel_cpu0Memory.v AXISoCQuadCoreModule_TopLevel_cpu0Memory_axiSlave.v AXISoCQuadCoreModule_TopLevel_CPU0_CPU.v AXISoCQuadCoreModule_TopLevel_CPU0_CPU_ALU.v AXISoCQuadCoreModule_TopLevel_CPU0_CPU_CMP.v AXISoCQuadCoreModule_TopLevel_CPU0_CPU_ID.v AXISoCQuadCoreModule_TopLevel_CPU0_CPU_Regs.v AXISoCQuadCoreModule_TopLevel_CPU0_Master.v AXISoCQuadCoreModule_TopLevel_CPUExtReset.v AXISoCQuadCoreModule_TopLevel_CPUExtReset_axiSlave.v AXISoCQuadCoreModule_TopLevel_ioInterconnect.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_DuplexMux.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_Encoder.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray0.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray0_encoder.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray0_rangeDetectors0.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray0_rangeDetectors1.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray0_rangeDetectors2.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray0_rangeDetectors3.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray0_rangeDetectors4.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray0_rangeDetectors5.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray0_rangeDetectors6.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray0_rangeDetectors7.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray0_rangeDetectors8.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray0_rangeDetectors9.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray1.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray1_encoder.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray1_rangeDetectors0.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray1_rangeDetectors1.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray1_rangeDetectors2.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray1_rangeDetectors3.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray1_rangeDetectors4.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray1_rangeDetectors5.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray1_rangeDetectors6.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray1_rangeDetectors7.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray1_rangeDetectors8.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_rangeDetectorArray1_rangeDetectors9.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_TransactionDetectors0.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_readInterconnect_TransactionDetectors1.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_DuplexMux.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_Encoder.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray0.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray0_encoder.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors0.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors1.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors2.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors3.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors4.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors5.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors6.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors7.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors8.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors9.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray1.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray1_encoder.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray1_rangeDetectors0.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray1_rangeDetectors1.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray1_rangeDetectors2.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray1_rangeDetectors3.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray1_rangeDetectors4.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray1_rangeDetectors5.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray1_rangeDetectors6.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray1_rangeDetectors7.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray1_rangeDetectors8.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_rangeDetectorArray1_rangeDetectors9.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_TransactionDetectors0.v AXISoCQuadCoreModule_TopLevel_ioInterconnect_writeInterconnect_TransactionDetectors1.v AXISoCQuadCoreModule_TopLevel_programmer.v AXISoCQuadCoreModule_TopLevel_programmerCPU0Gateway.v AXISoCQuadCoreModule_TopLevel_programmerCPU0Gateway_readAddress.v AXISoCQuadCoreModule_TopLevel_programmerCPU0Gateway_writeAddress.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_readInterconnect.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_readInterconnect_DuplexMux.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_readInterconnect_Encoder.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_readInterconnect_rangeDetectorArray0.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_readInterconnect_rangeDetectorArray0_encoder.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_readInterconnect_rangeDetectorArray0_rangeDetectors0.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_readInterconnect_rangeDetectorArray0_rangeDetectors1.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_readInterconnect_TransactionDetectors0.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_writeInterconnect.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_writeInterconnect_DuplexMux.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_writeInterconnect_Encoder.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_writeInterconnect_rangeDetectorArray0.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_writeInterconnect_rangeDetectorArray0_encoder.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors0.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_writeInterconnect_rangeDetectorArray0_rangeDetectors1.v AXISoCQuadCoreModule_TopLevel_programmerInterconnect_writeInterconnect_TransactionDetectors0.v AXISoCQuadCoreModule_TopLevel_programmerIOGateway.v AXISoCQuadCoreModule_TopLevel_programmerIOGateway_readAddress.v AXISoCQuadCoreModule_TopLevel_programmerIOGateway_writeAddress.v AXISoCQuadCoreModule_TopLevel_programmer_masterModule.v AXISoCQuadCoreModule_TopLevel_programmer_receiverFIFO.v AXISoCQuadCoreModule_TopLevel_programmer_transmitterFIFO.v AXISoCQuadCoreModule_TopLevel_programmer_uartClockControl.v AXISoCQuadCoreModule_TopLevel_programmer_uartReceiver.v AXISoCQuadCoreModule_TopLevel_programmer_uartTransmitter.v AXISoCQuadCoreModule_TopLevel_pwm.v AXISoCQuadCoreModule_TopLevel_pwm_axiSlave.v AXISoCQuadCoreModule_TopLevel_pwm_pwms0.v AXISoCQuadCoreModule_TopLevel_pwm_pwms1.v AXISoCQuadCoreModule_TopLevel_pwm_pwms2.v AXISoCQuadCoreModule_TopLevel_pwm_pwms3.v AXISoCQuadCoreModule_TopLevel_pwm_pwms4.v AXISoCQuadCoreModule_TopLevel_pwm_pwms5.v AXISoCQuadCoreModule_TopLevel_pwm_pwms6.v AXISoCQuadCoreModule_TopLevel_pwm_pwms7.v AXISoCQuadCoreModule_TopLevel_Reg0.v AXISoCQuadCoreModule_TopLevel_Reg0_axiSlave.v AXISoCQuadCoreModule_TopLevel_Reg1.v AXISoCQuadCoreModule_TopLevel_Reg1_axiSlave.v AXISoCQuadCoreModule_TopLevel_Reg2.v AXISoCQuadCoreModule_TopLevel_Reg2_axiSlave.v AXISoCQuadCoreModule_TopLevel_Reg3.v AXISoCQuadCoreModule_TopLevel_Reg3_axiSlave.v AXISoCQuadCoreModule_TopLevel_Switches.v AXISoCQuadCoreModule_TopLevel_Switches_axiSlave.v AXISoCQuadCoreModule_TopLevel_uart.v AXISoCQuadCoreModule_TopLevel_uart_axiSlave.v AXISoCQuadCoreModule_TopLevel_uart_receiverFIFO.v AXISoCQuadCoreModule_TopLevel_uart_transmitterFIFO.v AXISoCQuadCoreModule_TopLevel_uart_uartClockControl.v AXISoCQuadCoreModule_TopLevel_uart_uartReceiver.v AXISoCQuadCoreModule_TopLevel_uart_uartTransmitter.v AXISoCQuadCoreModule_TopLevel_ws2812.v AXISoCQuadCoreModule_TopLevel_ws2812_axiSlave.v Quokka.v

#PART = xc7a100tcsg324-1
PART = xc7z020clg400-1

.PHONY: all
all: top.bit

.PHONY: program
program: top.bit
	openFPGALoader --board Arty Z7-20 --bitstream $<

top.json: top.v $(ADDITIONAL_SOURCES)
	yosys -p "synth_xilinx -flatten -abc9 -nobram -arch xc7 -top top; write_json top.json" $^

# The chip database only needs to be generated once
# that is why we don't clean it with make clean
${CHIPDB}/${PART}.bin:
	pypy3 /nextpnr-xilinx/xilinx/python/bbaexport.py --device ${PART} --bba ${PART}.bba
	bbasm -l ${PART}.bba ${CHIPDB}/${PART}.bin
	rm -f ${PART}.bba

top.fasm: top.json ${CHIPDB}/${PART}.bin
	nextpnr-xilinx --chipdb ${CHIPDB}/${PART}.bin --xdc Arty-Z7-20-Master.xdc --json top.json --fasm $@ --verbose --debug
	
top.frames: top.fasm
	fasm2frames --part ${PART} --db-root ${DB_DIR}/${CHIPFAM} $< > $@ #FIXME: fasm2frames should be on PATH

top.bit: top.frames
	xc7frames2bit --part_file ${DB_DIR}/${CHIPFAM}/${PART}/part.yaml --part_name ${PART} --frm_file $< --output_file $@

.PHONY: clean
clean:
	@rm -f *.bit
	@rm -f *.frames
	@rm -f *.fasm
	@rm -f *.json
